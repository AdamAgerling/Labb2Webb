@inherits LayoutComponentBase
@using BlazorFrontend.Extensions
@using BlazorFrontend.Providers
@using BlazorFrontend.Services
@using Labb2Webb.Shared.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject CustomerService CustomerService

<div>
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand text fw-bold fs-3" href="/">ynet</a>
                <div class="collapse navbar-collapse">
                    <div class="align-content-center"><input type="text" placeholder="Search for a product..."/></div>
                    <ul class="navbar-nav ms-auto">
                        <AuthorizeView>
                            <Authorized>
                                @{
                                    var fullName = context.User.FindFirst("FullName")?.Value;
                                    var displayName = !string.IsNullOrWhiteSpace(fullName) ? fullName : context.User.Identity.Name;
                                    if (!string.IsNullOrWhiteSpace(displayName))
                                    {
                                        var parts = displayName.Split(' ');
                                        if (parts.Length >= 2)
                                        {
                                            displayName = $"{parts[0]} {parts[1].Substring(0, 1)}.";
                                        }
                                    }
                                }
                                <li class="nav-item">
                                    <a class="nav-link" href="/profile"> @displayName</a>
                                </li>
                                <li class="nav-item">
                                    <button class="btn btn-link nav-link" @onclick="Logout">Logout</button>
                                </li>
                            </Authorized>
                            <NotAuthorized>
                                <li class="nav-item">
                                    <a class="nav-link" href="/login">
                                        <i class="bi bi-person-circle"></i>
                                        Login
                                    </a>
                                </li>
                            </NotAuthorized>
                        </AuthorizeView>
                        <li>
                            <button type="button" class="btn btn-success px-3">
                                <i class="bi bi-cart3 pe-1"></i>
                                Cart
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <div class="row">
        <div class="col-md-3 sidebar">
            <NavMenu />
        </div>
        <div class="col-md-9">
            @Body
        </div>
    </div>

    <footer class="mt-3 text-center bg-dark text-white">
        &copy; 2025 ynet
    </footer>
</div>

@code {
    private CustomerDto customerProfile;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            customerProfile = await CustomerService.GetLoggedInCustomerProfileAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error loading profile: " + ex);
        }
    }


    private async Task Logout()
    {
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "authToken");
        if (AuthStateProvider is CustomAuthenticationStateProvider customAuthProvider)
        {
            customAuthProvider.MarkUserAsLoggedOut();
        }
        Navigation.NavigateTo("/", true);
    }

}
